<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ú–æ–π –ö—É–±</title>
  <style>
    body {
      background: #0a0a0a;
      color: #00f5d4;
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      padding: 40px 20px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
    }
    button {
      background: #0a0a0a;
      border: 1px solid #00f5d4;
      color: #00f5d4;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #00f5d4;
      color: #000;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background: #111;
      color: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #222;
      padding: 8px 10px;
    }
    th {
      background: #00f5d4;
      color: #000;
      font-weight: bold;
    }
    input {
      width: 100%;
      background: transparent;
      border: none;
      color: #fff;
      outline: none;
      text-align: center;
    }
    input:focus {
      background: #1a1a1a;
    }
    .actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .deleteBtn {
      background: #ff3b30;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 5px;
      cursor: pointer;
    }
    .addBtn {
      background: #00f5d4;
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>‚öô –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚Äî –ú–æ–π –ö—É–±</h1>
  <div>
    <button onclick="loadData('getRent')">–ê—Ä–µ–Ω–¥–∞</button>
    <button onclick="loadData('getAuction')">–ê—É–∫—Ü–∏–æ–Ω</button>
    <button onclick="loadData('getStory')">–ö—É–± –î–æ–±—Ä–∞</button>
    <button onclick="loadData('getHeroes')">–ì–µ—Ä–æ–∏</button>
  </div>

  <table id="dataTable"><tr><td>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</td></tr></table>

  <div class="actions">
    <button id="addRowBtn" class="addBtn" style="display:none;" onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
    <button id="saveBtn" class="addBtn" style="display:none;" onclick="saveData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
  </div>

  <script>
    const API_URL = '/api/sheets';
    const SECRET = 'MYKUB_SECRET_2025';
    let currentAction = '';

    async function loadData(action) {
      currentAction = action;
      document.getElementById('dataTable').innerHTML = '<tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
      document.getElementById('addRowBtn').style.display = 'inline-block';
      document.getElementById('saveBtn').style.display = 'inline-block';

      try {
        const res = await fetch(`${API_URL}?action=${action}&secret=${SECRET}`);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
        renderTable(data.data || []);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err);
      }
    }

    function renderTable(data) {
      const table = document.getElementById('dataTable');
      table.innerHTML = '';
      if (!data.length) {
        table.innerHTML = '<tr><td>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
      }

      const headers = data[0];
      const rows = data.slice(1);

      // –ó–∞–≥–æ–ª–æ–≤–∫–∏
      const thead = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h || '';
        thead.appendChild(th);
      });
      const actTh = document.createElement('th');
      actTh.textContent = '–î–µ–π—Å—Ç–≤–∏—è';
      thead.appendChild(actTh);
      table.appendChild(thead);

      // –î–∞–Ω–Ω—ã–µ
      rows.forEach((row, idx) => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.value = cell || '';
          td.appendChild(inp);
          tr.appendChild(td);
        });
        // –ö–Ω–æ–ø–∫–∏
        const tdAct = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóë';
        delBtn.className = 'deleteBtn';
        delBtn.onclick = () => tr.remove();

        // –ï—Å–ª–∏ —ç—Ç–æ –∞—É–∫—Ü–∏–æ–Ω ‚Äî –¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è"
        if (currentAction === 'getAuction') {
          const winBtn = document.createElement('button');
          winBtn.textContent = 'üèÜ';
          winBtn.style.background = '#00f5d4';
          winBtn.style.color = '#000';
          winBtn.onclick = () => appointWinner(row);
          tdAct.appendChild(winBtn);
        }

        tdAct.appendChild(delBtn);
        tr.appendChild(tdAct);
        table.appendChild(tr);
      });
    }

    function addRow() {
      const table = document.getElementById('dataTable');
      const cols = table.querySelectorAll('th').length - 1;
      if (cols < 1) return;
      const tr = document.createElement('tr');
      for (let i = 0; i < cols; i++) {
        const td = document.createElement('td');
        const inp = document.createElement('input');
        td.appendChild(inp);
        tr.appendChild(td);
      }
      const tdAct = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóë';
      delBtn.className = 'deleteBtn';
      delBtn.onclick = () => tr.remove();
      tdAct.appendChild(delBtn);
      tr.appendChild(tdAct);
      table.appendChild(tr);
    }

    async function saveData() {
      const table = document.getElementById('dataTable');
      const rows = [...table.querySelectorAll('tr')].map(tr =>
        [...tr.querySelectorAll('td input')].map(inp => inp.value.trim())
      );
      if (!rows.length) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');

      try {
        const payload = {
          type: 'update' + currentAction.replace('get', ''),
          secret: SECRET,
          rows
        };
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (j.ok) alert('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        else alert('–û—à–∏–±–∫–∞: ' + j.error);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err);
      }
    }

    async function appointWinner(row) {
      if (!confirm('–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–º —Å—Ç–∞–≤–∫—É: ' + row.join(' | ') + '?')) return;

      try {
        const payload = {
          type: 'rent',
          secret: SECRET,
          cubeId: '–¶–µ–Ω—Ç—Ä',
          name: row[2] || '',
          contact: row[3] || '',
          link: row[4] || '',
          message: '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∞—É–∫—Ü–∏–æ–Ω–∞'
        };
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (j.ok) alert('üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞—Ä–µ–Ω–¥—É!');
        else alert('–û—à–∏–±–∫–∞: ' + j.error);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è: ' + err);
      }
    }
  </script>
</body>
</html>
