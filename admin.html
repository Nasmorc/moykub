<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ú–æ–π –ö—É–±</title>
<style>
  body{background:#0a0a0a;color:#00f5d4;font-family:Segoe UI,sans-serif;text-align:center;margin:0;padding:32px}
  h1{margin:0 0 12px}
  .tabs button{background:#0a0a0a;border:1px solid #00f5d4;color:#00f5d4;margin:4px;padding:8px 14px;border-radius:6px;cursor:pointer}
  .tabs button.active,.tabs button:hover{background:#00f5d4;color:#000}
  table{width:92%;margin:18px auto;border-collapse:collapse;background:#111;color:#fff;border-radius:8px;overflow:hidden}
  th,td{border:1px solid #222;padding:8px}
  th{background:#00f5d4;color:#000}
  input,select,textarea{width:100%;background:transparent;border:1px solid #1f1f1f;color:#fff;padding:6px;border-radius:6px}
  .row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;align-items:end;width:92%;margin:10px auto}
  .row .full{grid-column:1/-1}
  .btn{background:#00f5d4;color:#000;border:none;padding:10px 16px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#0a0a0a;border:1px solid #00f5d4;color:#00f5d4}
  .flex{display:flex;gap:10px;justify-content:center}
  .note{opacity:.8}
select option {
  background-color: #00f5d4; /* —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π —Ñ–æ–Ω */
  color: #000;              /* —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
}
</style>
</head>
<body>
  <h1>‚öô –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚Äî –ú–æ–π –ö—É–±</h1>–´

  <div class="tabs">
    <button onclick="loadTab('getRent', this)">–ê—Ä–µ–Ω–¥–∞</button>
    <button onclick="loadTab('getAuction', this)">–ê—É–∫—Ü–∏–æ–Ω</button>
    <button onclick="loadTab('getStory', this)">–ö—É–± –î–æ–±—Ä–∞</button>
    <button onclick="loadTab('getHeroes', this)">–ì–µ—Ä–æ–∏</button>
  </div>

  <div id="assignForm" style="display:none">
    <h3>üß© –í—ã–¥–∞—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å –∫—É–±</h3>
    <div class="row">
      <div>
        <label>–¢–∏–ø</label>
        <select id="fType">
          <option value="rent">–û–±—ã—á–Ω—ã–π –∫—É–±</option>
          <option value="center">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫—É–±</option>
          <option value="heroes">–ì–µ—Ä–æ–π –º–µ—Å—è—Ü–∞</option>
          <option value="story">–ö—É–± –î–æ–±—Ä–∞</option>
        </select>
      </div>
      <div id="cubeWrap">
        <label>–ö—É–±</label>
        <select id="fCube"></select>
      </div>
      <div>
        <label>–ò–º—è</label>
        <input id="fName" />
      </div>
      <div>
        <label>–ö–æ–Ω—Ç–∞–∫—Ç / @tg / —Ç–µ–ª–µ—Ñ–æ–Ω</label>
        <input id="fContact" />
      </div>
      <div>
        <label>–°—Å—ã–ª–∫–∞</label>
        <input id="fLink" />
      </div>
      <div class="full">
        <label>–§–æ—Ç–æ (URL)</label>
        <input id="fPhoto" />
      </div>
      <div class="full">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="fDesc" rows="3"></textarea>
      </div>
      <div class="full" id="videoWrap" style="display:none">
        <label>–í–∏–¥–µ–æ (–¥–ª—è –ì–µ—Ä–æ—è)</label>
        <input id="fVideo" />
      </div>
    </div>
    <div class="flex">
      <button class="btn" onclick="assignCube()">‚úÖ –í—ã–¥–∞—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn secondary" onclick="clearCube()">üóë –û—á–∏—Å—Ç–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫—É–±–∞</button>
      <button class="btn secondary" onclick="refreshActive()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
    </div>
    <div class="note">* –æ—á–∏—Å—Ç–∫–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç –Ω–æ–º–µ—Ä –∏ –º–µ—Å—Ç–æ –∫—É–±–∞ ‚Äî –æ–Ω –≤–µ—Ä–Ω—ë—Ç—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>
  </div>

  <!-- –ë–ª–æ–∫ –∞—É–∫—Ü–∏–æ–Ω–∞ -->
  <div id="auctionBlock" style="display:none">
    <h3>üèÅ –ê—É–∫—Ü–∏–æ–Ω ¬´–¶–ï–ù–¢–†¬ª</h3>
    <div class="flex">
      <button class="btn" onclick="startAuction()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ 72 —á–∞—Å–∞</button>
      <button class="btn secondary" onclick="assignWinner()">üèÜ –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</button>
      <button class="btn secondary" onclick="closeAuction()">‚õî –ó–∞–∫—Ä—ã—Ç—å –∞—É–∫—Ü–∏–æ–Ω</button>
    </div>
    <p id="auctionTimer" class="note">–û—Å—Ç–∞–ª–æ—Å—å: ‚Äî</p>
  </div>

  <table id="dataTable"><tr><td>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</td></tr></table>

<script>
const API = '/api/sheets';
const SECRET = 'MYKUB_SECRET_2025';
let activeTab = '';

function toast(msg){ alert(msg); }

async function loadTab(tab, btn){
  activeTab = tab;
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  btn && btn.classList.add('active');

  // –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö, –∫—Ä–æ–º–µ —á–∏—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–≤–æ–∫?
  document.getElementById('assignForm').style.display = (tab==='getAuction' ? 'block' : 'block');
  document.getElementById('auctionBlock').style.display = (tab==='getAuction' ? 'block' : 'none');

  prepareCubeSelect();
  renderTimer();

  const r = await fetch(`${API}?action=${tab}&secret=${SECRET}`);
  const j = await r.json();
  if (!j.ok){ toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+(j.error||'')); return; }
  renderTable(j.data||[]);
}

function prepareCubeSelect(){
  const t = document.getElementById('fType').value;
  const cubeWrap = document.getElementById('cubeWrap');
  const videoWrap = document.getElementById('videoWrap');
  const sel = document.getElementById('fCube');
  sel.innerHTML = '';
  videoWrap.style.display = (t==='heroes') ? 'block' : 'none';

  if (t === 'rent'){
    for(let i=1;i<=110;i++){
      const o=document.createElement('option'); o.value=String(i); o.textContent='#'+i; sel.appendChild(o);
    }
  }else if (t === 'center'){
    const o=document.createElement('option'); o.value='–¶–ï–ù–¢–†'; o.textContent='–¶–ï–ù–¢–†'; sel.appendChild(o);
  }else if (t === 'heroes'){
    ['1','2','3'].forEach(id=>{ const o=document.createElement('option'); o.value=id; o.textContent='–ì–µ—Ä–æ–π '+id; sel.appendChild(o);});
  }else if (t === 'story'){
    // story –Ω–∞–∑–Ω–∞—á–∞–µ–º –∫–∞–∫ –∑–∞–ø–∏—Å–∏ —Å id ‚Äî –ø—É—Å—Ç—å –±—É–¥–µ—Ç —Ç–æ—Ç –∂–µ —Å–ø–∏—Å–æ–∫ #1..#110, –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –ª—é–±–æ–π id
    for(let i=1;i<=110;i++){
      const o=document.createElement('option'); o.value=String(i); o.textContent='–ò—Å—Ç–æ—Ä–∏—è #'+i; sel.appendChild(o);
    }
  }
}

document.getElementById('fType').addEventListener('change', prepareCubeSelect);

function renderTable(rows){
  const tbl = document.getElementById('dataTable');
  tbl.innerHTML = '';
  if (!rows.length){ tbl.innerHTML='<tr><td>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>'; return; }
  const thead = document.createElement('tr');
  rows[0].forEach(h=>{ const th=document.createElement('th'); th.textContent=h||''; thead.appendChild(th); });
  tbl.appendChild(thead);
  rows.slice(1).forEach(r=>{
    const tr=document.createElement('tr');
    r.forEach(c=>{ const td=document.createElement('td'); td.textContent=c||''; tr.appendChild(td); });
    tbl.appendChild(tr);
  });
}

// –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞–∫–µ—Ç–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü
async function saveTable(type, rows){
  const res = await fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type, secret:SECRET, rows})
  });
  return res.json();
}

// –≤—ã–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∫—É–± (–≤—Å–µ —Ç–∏–ø—ã)
async function assignCube(){
  const t = document.getElementById('fType').value;
  const cube = document.getElementById('fCube').value;
  const item = {
    cube: cube,
    name: document.getElementById('fName').value.trim(),
    contact: document.getElementById('fContact').value.trim(),
    link: document.getElementById('fLink').value.trim(),
    photo: document.getElementById('fPhoto').value.trim(),
    desc: document.getElementById('fDesc').value.trim()
  };

  if (t==='rent' || t==='center'){
    const r = await fetch(API,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({type:'upsertRent', secret:SECRET, item: {...item, cube: (t==='center'?'–¶–ï–ù–¢–†':cube)}})
    }).then(r=>r.json());
    if (r.ok){ toast('‚úÖ –ì–æ—Ç–æ–≤–æ'); refreshActive(); } else toast('–û—à–∏–±–∫–∞: '+(r.error||''));
  }
  if (t==='heroes'){
    const r = await fetch(API,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({type:'upsertHero', secret:SECRET, item: {
        id: cube, name: item.name, photo:item.photo, link:item.link, description:item.desc, video: document.getElementById('fVideo').value.trim()
      }})
    }).then(r=>r.json());
    if (r.ok){ toast('‚úÖ –ì–µ—Ä–æ–π –æ–±–Ω–æ–≤–ª—ë–Ω'); refreshActive(); } else toast('–û—à–∏–±–∫–∞: '+(r.error||''));
  }
  if (t==='story'){
    const r = await fetch(API,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({type:'upsertStory', secret:SECRET, item: {
        id: cube, name:item.name, contact:item.contact, link:item.link, story:item.desc
      }})
    }).then(r=>r.json());
    if (r.ok){ toast('‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); refreshActive(); } else toast('–û—à–∏–±–∫–∞: '+(r.error||''));
  }
}

// –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫—É–±–∞ (rent)
async function clearCube(){
  const t = document.getElementById('fType').value;
  const cube = document.getElementById('fCube').value;
  if (t!=='rent' && t!=='center'){ toast('–û—á–∏—Å—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è ‚Äú–ê—Ä–µ–Ω–¥–∞/–¶–µ–Ω—Ç—Ä‚Äù'); return; }
  if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫—É–±–∞ '+(t==='center'?'–¶–ï–ù–¢–†':'#'+cube)+' ?')) return;
  const r = await fetch(API,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type:'clearRentByCube', secret:SECRET, cube:(t==='center'?'–¶–ï–ù–¢–†':cube)})
  }).then(r=>r.json());
  if (r.ok){ toast('‚úÖ –û—á–∏—â–µ–Ω–æ'); refreshActive(); } else toast('–û—à–∏–±–∫–∞: '+(r.error||'')); 
}

async function refreshActive(){
  if (!activeTab) return;
  const r = await fetch(`${API}?action=${activeTab}&secret=${SECRET}`).then(r=>r.json());
  if (r.ok) renderTable(r.data); else toast('–û—à–∏–±–∫–∞: '+(r.error||''));
}

/** ===== –ê—É–∫—Ü–∏–æ–Ω ===== */
async function startAuction(){
  if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞—É–∫—Ü–∏–æ–Ω –Ω–∞ 72 —á–∞—Å–∞?')) return;
  const r = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type:'startAuction', secret:SECRET, durationHours:72})
  }).then(r=>r.json());
  if (r.ok){ toast('üöÄ –ê—É–∫—Ü–∏–æ–Ω –∑–∞–ø—É—â–µ–Ω'); renderTimer(); refreshActive(); }
  else toast('–û—à–∏–±–∫–∞: '+(r.error||''));
}

async function closeAuction(){
  const r = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type:'closeAuction', secret:SECRET})
  }).then(r=>r.json());
  if (r.ok){ toast('‚õî –ó–∞–∫—Ä—ã—Ç'); renderTimer(); } else toast('–û—à–∏–±–∫–∞: '+(r.error||''));
}

async function assignWinner(){
  if (!confirm('–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (–º–∞–∫—Å —Å—Ç–∞–≤–∫–∞)?')) return;
  const r = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type:'assignAuctionWinner', secret:SECRET})
  }).then(r=>r.json());
  if (r.ok){ toast('üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω'); refreshActive(); }
  else toast('–û—à–∏–±–∫–∞: '+(r.error||''));
}

async function renderTimer(){
  const blk = document.getElementById('auctionBlock');
  if (blk.style.display==='none') return;
  const el = document.getElementById('auctionTimer');
  const meta = await fetch(`${API}?action=getAuctionMeta&secret=${SECRET}`).then(r=>r.json());
  if (!meta.ok || !meta.data || meta.data.length<=1){ el.textContent='–û—Å—Ç–∞–ª–æ—Å—å: ‚Äî'; return; }
  const r = meta.data[1]; // start, end, active
  const end = new Date(r[1]).getTime(); const active = (String(r[2])==='1');
  const tick = ()=>{
    const left = end - Date.now();
    if (!active || left<=0){ el.textContent='–ê—É–∫—Ü–∏–æ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω'; return; }
    const d = Math.floor(left/86400000);
    const h = Math.floor((left%86400000)/3600000);
    const m = Math.floor((left%3600000)/60000);
    el.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${d}–¥ ${h}—á ${m}–º`;
    setTimeout(tick, 60000);
  };
  tick();
}

// –¥–µ—Ñ–æ–ª—Ç ‚Äì –æ—Ç–∫—Ä–æ–µ–º ‚Äú–ê—Ä–µ–Ω–¥–∞‚Äù
loadTab('getRent', document.querySelector('.tabs button'));
</script>
</body>
</html>
